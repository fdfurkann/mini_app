#!/bin/bash

# ==============================================================================
# Tinyproxy Otomatik Kurulum ve YapÄ±landÄ±rma BetiÄŸi
# ==============================================================================

# BetiÄŸin root yetkileriyle Ã§alÄ±ÅŸÄ±p Ã§alÄ±ÅŸmadÄ±ÄŸÄ±nÄ± kontrol et
if [ "$(id -u)" -ne 0 ]; then
  echo "Bu betiÄŸi Ã§alÄ±ÅŸtÄ±rmak iÃ§in root yetkilerine sahip olmalÄ±sÄ±nÄ±z." >&2
  echo "LÃ¼tfen 'sudo ./install_tinyproxy.sh' komutunu kullanÄ±n." >&2
  exit 1
fi

# KullanÄ±cÄ±dan gerekli bilgileri al
clear
echo "Tinyproxy Otomatik Kurulum SihirbazÄ±na HoÅŸ Geldiniz."
echo "-----------------------------------------------------"
read -p "LÃ¼tfen proxy'nin eriÅŸimine izin verilecek ANA sunucunuzun IP adresini girin: " MAIN_SERVER_IP

# IP adresi boÅŸ olamaz
if [[ -z "$MAIN_SERVER_IP" ]]; then
    echo "Hata: Ana sunucu IP adresi boÅŸ bÄ±rakÄ±lamaz." >&2
    exit 1
fi

read -p "Proxy iÃ§in kullanÄ±lacak port numarasÄ±nÄ± girin (VarsayÄ±lan: 8888): " PROXY_PORT
# EÄŸer port boÅŸ bÄ±rakÄ±lÄ±rsa varsayÄ±lan olarak 8888 kullan
PROXY_PORT=${PROXY_PORT:-8888}

echo ""
echo "--------------------------------------------------"
echo "AyarlarÄ±nÄ±z OnaylanÄ±yor:"
echo "Ä°zin Verilecek IP (Ana Sunucunuz): $MAIN_SERVER_IP"
echo "Proxy Port NumarasÄ±              : $PROXY_PORT"
echo "--------------------------------------------------"
read -p "Ayarlar doÄŸruysa devam etmek iÃ§in Enter'a basÄ±n. Ä°ptal etmek iÃ§in CTRL+C'ye basÄ±n."

# --- Kurulum BaÅŸlÄ±yor ---

echo ""
echo "Ä°ÅŸlem baÅŸladÄ±. LÃ¼tfen bekleyin..."
echo ""

# 1. Sistem paketlerini gÃ¼ncelle
echo "[1/5] Sistem paketleri gÃ¼ncelleniyor..."
apt-get update > /dev/null 2>&1 && apt-get upgrade -y > /dev/null 2>&1
echo "    -> GÃ¼ncelleme tamamlandÄ±."

# 2. Tinyproxy'yi kur
echo "[2/5] Tinyproxy kuruluyor..."
apt-get install tinyproxy -y > /dev/null 2>&1
echo "    -> Tinyproxy kurulumu tamamlandÄ±."

# 3. Mevcut yapÄ±landÄ±rmayÄ± yedekle ve yenisini oluÅŸtur
echo "[3/5] Tinyproxy yapÄ±landÄ±rmasÄ± oluÅŸturuluyor..."
CONFIG_FILE="/etc/tinyproxy/tinyproxy.conf"
mv $CONFIG_FILE ${CONFIG_FILE}.bak_$(date +%F)

# Heredoc kullanarak yeni ve temiz bir yapÄ±landÄ±rma dosyasÄ± oluÅŸtur
cat << EOF > $CONFIG_FILE
# Otomatik olarak oluÅŸturulan Tinyproxy yapÄ±landÄ±rmasÄ±
User nobody
Group nogroup

Port ${PROXY_PORT}
Timeout 600
LogLevel Info
LogFile "/var/log/tinyproxy/tinyproxy.log"
PidFile "/run/tinyproxy/tinyproxy.pid"

# Her yerden gelen baÄŸlantÄ±larÄ± dinle (eriÅŸim 'Allow' ile kÄ±sÄ±tlanacak)
Listen 0.0.0.0

# SADECE ANA SUNUCUDAN GELEN Ä°STEKLERE Ä°ZÄ°N VER
Allow 170.64.201.133

# Performans ayarlarÄ±
MaxClients 100
MinSpareServers 5
MaxSpareServers 20
StartServers 10

# GÃ¼venlik ve Gizlilik AyarlarÄ± (Proxy kullanÄ±ldÄ±ÄŸÄ±nÄ± gizler)
DisableViaHeader Yes
Anonymous "Via"
Anonymous "X-Forwarded-For"
EOF

echo "    -> YapÄ±landÄ±rma dosyasÄ± baÅŸarÄ±yla oluÅŸturuldu."

# 4. Tinyproxy servisini yeniden baÅŸlat ve baÅŸlangÄ±Ã§ta Ã§alÄ±ÅŸacak ÅŸekilde ayarla
echo "[4/5] Tinyproxy servisi yeniden baÅŸlatÄ±lÄ±yor..."
systemctl restart tinyproxy
systemctl enable tinyproxy > /dev/null 2>&1
echo "    -> Servis yeniden baÅŸlatÄ±ldÄ± ve baÅŸlangÄ±ca eklendi."

# 5. Kurulumun sonucunu kontrol et ve bilgileri gÃ¶ster
echo "[5/5] Kurulum durumu kontrol ediliyor..."
sleep 2 # Servisin baÅŸlamasÄ± iÃ§in kÄ±sa bir bekleme

# Bu sunucunun genel IP adresini al
SERVER_IP=$(hostname -I | awk '{print $1}')

if systemctl is-active --quiet tinyproxy; then
    echo ""
    echo "------------------------------------------------------------------"
    echo "ğŸ‰ Tinyproxy baÅŸarÄ±yla kuruldu ve Ã§alÄ±ÅŸÄ±yor! ğŸ‰"
    echo "------------------------------------------------------------------"
    echo ""
    echo "Ana uygulamanÄ±zÄ±n Ã§alÄ±ÅŸtÄ±ÄŸÄ± sunucudaki .env dosyanÄ±za eklemeniz gereken satÄ±r:"
    echo ""
    echo "PROXY_URL=http://${SERVER_IP}:${PROXY_PORT}"
    echo ""
    echo "Ã–NEMLÄ° NOT: EÄŸer bir gÃ¼venlik duvarÄ± (firewall) kullanÄ±yorsanÄ±z,"
    echo "${PROXY_PORT} numaralÄ± porta gelen TCP trafiÄŸine izin vermeniz gerekmektedir."
    echo "Ã–rnek (UFW iÃ§in): sudo ufw allow ${PROXY_PORT}/tcp"
    echo ""
    echo "------------------------------------------------------------------"
else
    echo "HATA: Tinyproxy servisi baÅŸlatÄ±lamadÄ±." >&2
    echo "LÃ¼tfen 'journalctl -u tinyproxy' komutu ile loglarÄ± kontrol edin." >&2
    exit 1
fi